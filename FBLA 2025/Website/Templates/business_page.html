{% extends "base.html" %}
{% block content %}

<div class="business-profile" style="display: flex; justify-content: center; align-items: center; min-height: calc(100vh - 100px); padding: 20px;">
  <div class="card" style="width: 100%; max-width: 1600px; padding: 40px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <!-- Edit Button (visible only to owner) -->
          {% if user.is_authenticated and business.user_id == user.id %}
          <div style="margin-top: 5px; padding-bottom: 30px; border-bottom: 2px solid #e0e0e0; display: flex; gap: 15px; flex-wrap: wrap;">
            <button href="{{ url_for('views.business_page', biz_id=business.id) }}" class="btn btn-primary" style="display: inline-block; padding: 10px 20px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 4px; font-weight: 500;">
        ‚úé Edit Business
            </button> <!--Review Button-->
            <button id="open-reviews-btn" class="btn btn-primary" style="display: inline-block; padding: 10px 20px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 4px; font-weight: 500">
        ‚ú™ Open Reviews
            </button> <!-- Map Button TO-DO!!! -->
            <button id="open-map-btn" class="btn btn-primary" style="display: inline-block; padding: 10px 20px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 4px; font-weight: 500">
        üñæ View Map
            </button>
          </div>
          <script> // Map Button Functionality (Still requires work on the backend to store actual addresses instead of just "none")
            document.getElementById('open-map-btn').addEventListener('click', function() {
              const address = "{{ business.location }}";
              const mapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(address)}`;
              window.open(mapsUrl, '_blank');
            });
          </script>
          {% else %}
          <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #e0e0e0; display: flex; gap: 15px; flex-wrap: wrap;">
            <button id="open-reviews-btn" class="btn btn-primary" style="display: inline-block; padding: 10px 20px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 4px; font-weight: 500">
        ‚ú™ Open Reviews
            </button>
            <button id="open-map-btn" class="btn btn-primary" style="display: inline-block; padding: 10px 20px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 4px; font-weight: 500">
        üñæ View Map
            </button>
          </div>
          {% endif %}
          
    <!-- Business Header Section -->
    <div style="margin-bottom: 30px; padding-top: 30px;">
      <h1 style="margin: 0; color: #333;"><strong><span class="highlight">{{ business.biz_name }}</span></strong></h1>
      <p style="color: #666; margin: 10px 0 0 0; font-size: 14px;">
        <em>Posted: {{ business.created_at.strftime('%B %d, %Y') if business.created_at else 'N/A' }}</em>
      </p>
    </div>

    <hr style="margin: 20px 0; border: none; border-top: 2px solid #e0e0e0;">

    <!-- Business Image Section -->
    {% if business.image_file %}
    <div style="margin-bottom: 30px; text-align: center;">
      <img 
        src="{{ url_for('static', filename='uploads/businesses/' + business.image_file) }}" 
        alt="{{ business.biz_name }}"
        style="max-width: 100%; height: auto; border-radius: 8px; max-height: 300px; object-fit: cover;">
    </div>
    {% else %}
    <div style="margin-bottom: 30px; text-align: center; padding: 40px; background-color: #f5f5f5; border-radius: 8px;">
      <p style="color: #999; margin: 0;">No image available</p>
    </div>
    {% endif %}

    <!-- Business Information Section -->
    <div style="background-color: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
      
      <!-- Category -->
      <div style="margin-bottom: 15px;">
        <p style="margin: 0 0 5px 0; color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Category</p>
      <span class="badge", style="font-size: 22px;">{{ business.category }}</span>
        </p>
      </div>

      <!-- Description -->
      {% if business.description %}
      <div style="margin-bottom: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
        <p style="margin: 0 0 5px 0; color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Description</p>
        <p style="margin: 0; font-size: 14px; line-height: 1.6; color: #555;">
          {{ business.description }}
        </p>
      </div>
      {% endif %}

    </div>

    <!-- Additional Info Section -->
    <div style="margin-bottom: 30px;">
      <p style="margin: 0 0 10px 0; color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Business Details</p>
      <ul style="margin: 0; padding-left: 20px; list-style: none;">
        <li style="padding: 8px 0; color: #555;">
          <strong>Business ID:</strong> #{{ business.id }}
        </li>
        <li style="padding: 8px 0; color: #555;">
          <strong>Owner:</strong> {{ business.owner.FirstName if business.owner else 'Unknown' }}
        </li>
        <li style="padding: 8px 0; color: #555;"> <!-- Location is comes out as "none" for some reason, needs to be fixed in the backend -->
          <strong>Address:</strong>  {{ business.location }} 
        </li>
        <li style="padding: 8px 0; color: #555;"> <!-- Phone number also needs to be fixed in the backend, currently comes out as "none" -->
            <strong>Phone:</strong> {{ business.biz_phone }}
        </li>
        <li style="padding: 8px 0; color: #555;"> <!-- Email also needs to be fixed in the backend, currently comes out as "none" -->
            <strong>Email:</strong> {{ business.biz_email }}
        </li>
        <li style="padding: 8px 0; color: #555;"> <!-- Website also needs to be fixed in the backend, currently comes out as "none" -->
            <strong>Website:</strong> {{ business.biz_site }}
        </li>
        <li style="padding: 8px 0; color: #555;">
          <strong>Created:</strong> {{ business.created_at.strftime('%B %d, %Y at %I:%M %p') if business.created_at else 'N/A' }}
        </li>
      </ul>
    </div>

    <!-- Reviews Button -->
<style>
  .business-profile { transition: transform 300ms ease; }
  .business-profile.shift-left { transform: translateX(-12.5vw); } /* shift left by half the panel width to make room for the reviews panel */
  .reviews-panel { width:25vw; max-width:25vw; background:#fff; box-shadow: -4px 0 12px rgba(0,0,0,0.08); position:fixed; right:0; top:80px; bottom:40px; transform: translateX(100%); transition: transform 300ms ease; overflow:auto; padding:20px; z-index:1200; border-left:1px solid #eee; }
  .reviews-panel.open { transform: translateX(0); }
  @media (max-width:900px){ .business-profile.shift-left { transform: translateX(-100vw); } .reviews-panel{ width:100vw; } }
</style>

  </div>
</div>

<!-- Sliding Reviews Panel (initially hidden) -->
<aside id="reviews-panel" class="reviews-panel" aria-hidden="true">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
    <h3 style="margin:0;">Customer Reviews</h3>
    <button id="close-reviews-btn" style="background:transparent; border:none; font-size:18px; cursor:pointer;">‚úï</button>
  </div>

  <!-- Review form inside panel -->
  <div style="margin-bottom:12px;">
    {% if current_user.is_authenticated and business.user_id != user.id %}
      <form method="POST" action="{{ url_for('views.add_review', biz_id=business.id) }}">
        <label for="panel-rating" style="display:block; margin-bottom:6px; font-weight:600;">Rating</label>
        <select id="panel-rating" name="rating" required style="width:100%; padding:8px; margin-bottom:8px;">
          <option value="">Select</option>
          {% for i in range(1, 6) %}
            <option value="{{ i }}">{{ i }} ‚òÖ</option>
          {% endfor %}
        </select>

        <label for="panel-content" style="display:block; margin-bottom:6px; font-weight:600;">Review</label>
        <textarea id="panel-content" name="content" placeholder="Write your review..." required style="width:100%; min-height:100px; padding:8px; margin-bottom:8px;"></textarea>

        <button type="submit" style="background:#007bff; color:#fff; border:none; padding:10px 14px; border-radius:6px; cursor:pointer;">Submit Review</button>
      </form>
    {% elif current_user.is_authenticated and business.user_id == user.id %}
      <p class="muted">‚ö†Ô∏è You cannot review your own business.</p>
    {% else %}
      <p class="muted">ü™µ Log in to leave a review.</p> <!--haha get it?-->
    {% endif %}
  </div>

  <hr style="border:none; border-top:1px solid #f0f0f0; margin:10px 0 14px 0;" />

  <div id="reviews-content">
    {% if reviews and reviews|length > 0 %}
      {% for r in reviews %}
        <div style="padding:12px; border-bottom:1px solid #f0f0f0;">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
            {% if r.user.profile_image %}
              <img src="{{ url_for('static', filename='uploads/profiles/' + r.user.profile_image) }}" alt="{{ r.user.FirstName }}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
            {% else %}
              <div style="width:40px; height:40px; border-radius:50%; background-color:var(--primary-color); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700;">{{ r.user.FirstName[0] }}</div>
            {% endif %}
            <strong>{{ r.user.FirstName }}</strong>
          </div>
          <div style="margin-bottom:6px;">{% for i in range(r.rating) %}‚òÖ{% endfor %}</div>
          <p style="margin:0 0 6px 0; color:#444;">{{ r.content }}</p>
          <small class="muted" style="color:#999;">{{ r.created_at.strftime('%b %d, %Y') }}</small>
        </div>
      {% endfor %}
    {% else %}
      <p class="muted">No reviews yet.</p>
    {% endif %}
  </div>
</aside>

<!-- removed duplicate inline review form (now inside the sliding reviews panel) -->
<!-- Reviews are displayed inside the sliding panel -->
<script>
  (function(){
    const openBtn = document.getElementById('open-reviews-btn');
    const closeBtn = document.getElementById('close-reviews-btn');
    const panel = document.getElementById('reviews-panel');
    const main = document.querySelector('.business-profile');

    function openPanel(){
      panel.classList.add('open');
      panel.setAttribute('aria-hidden','false');
      if(main) main.classList.add('shift-left');
    }
    function closePanel(){
      panel.classList.remove('open');
      panel.setAttribute('aria-hidden','true');
      if(main) main.classList.remove('shift-left');
    }

    if(openBtn) openBtn.addEventListener('click', openPanel);
    if(closeBtn) closeBtn.addEventListener('click', closePanel);

    // close panel on Escape
    document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closePanel(); });
  })();
</script>
{% endblock %}
